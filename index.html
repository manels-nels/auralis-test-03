<!DOCTYPE html>
<html>
<head>
    <title>Simple AR Click Test with Sound Toggle and Multiple Jellyfish</title> <!-- Titre mis à jour -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="A-Frame + AR.js with clickable images, sound toggle, and multiple jellyfish created via JS."> <!-- Description mise à jour -->

    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <style>
        /* Style pour le corps et le message pop-up */
        body { margin: 0; overflow: hidden; font-family: sans-serif; }
        #message-popup {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);
            z-index: 10; background-color: rgba(0, 0, 0, 0.7); color: white;
            padding: 15px 25px; border-radius: 5px; text-align: center;
            font-size: 1.2em; display: none; cursor: pointer;
        }
        /* NOUVEAU: Style pour le bouton Son */
        #sound-toggle-button {
            position: absolute; bottom: 20px; left: 20px; z-index: 9;
            padding: 10px 15px; font-size: 1em; font-family: sans-serif; color: #333;
            background-color: rgba(255, 255, 255, 0.8); border: 1px solid #ccc;
            border-radius: 5px; cursor: pointer; display: none;
        }
        #sound-toggle-button:hover { background-color: rgba(255, 255, 255, 1); }
    </style>
</head>

<body style='margin : 0px; overflow: hidden;'>

    <!-- Div HTML pour afficher le message (initialement cachée) -->
    <div id="message-popup"></div>

    <!-- NOUVEAU: Bouton pour contrôler le son du logo -->
    <button id="sound-toggle-button">Play Sound</button>

    <!-- Scène A-Frame AR -->
    <a-scene
        id="ar-scene"  <!-- ID Important pour JS -->
        embedded
        arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'
        renderer='logarithmicDepthBuffer: true;'
        vr-mode-ui='enabled: false'>

        <!-- Assets : Précharger les images, le son ET le modèle 3D -->
        <a-assets timeout="60000"> <!-- Augmentation du timeout si le modèle est lourd -->
             <!-- Images -->
             <img id="logoAsset" src="images/logo.jpg" crossOrigin="anonymous">
             <img id="wangMengAsset" src="images/wang_meng.jpg" crossOrigin="anonymous">
             <!-- Audio -->
             <audio id="logoAudio" src="audio/auralis.mp3" preload="auto" crossOrigin="anonymous"></audio>
             <!-- Modèle 3D (UNE SEULE FOIS) -->
             <a-asset-item id="jellyfishModel" src="models/meduse.glb" crossOrigin="anonymous"></a-asset-item>
        </a-assets>

        <!-- L'image cliquable en RA (logo) AVEC SON (sans autoplay) -->
        <a-image
            id="clickable-logo"
            src="#logoAsset"
            position="0 1.5 -3"
            width="1" height="1"
            data-interactive
            sound="src: #logoAudio; loop: true; volume: 0.8; positional: true"
            >
        </a-image>

        <!-- La deuxième image cliquable (wangmeng) SANS SON -->
        <a-image
            id="clickable-wangmeng"
            src="#wangMengAsset"
            position="1.5 1.5 -3"
            width="1" height="1"
            data-interactive
            >
        </a-image>

        <!-- Les méduses seront ajoutées ici par JavaScript -->

        <!-- Caméra avec raycaster pour détecter les clics -->
        <a-camera
            cursor="rayOrigin: mouse; fuse: false;"
            raycaster="objects: [data-interactive];"
            >
        </a-camera>

    </a-scene>

    <!-- Script pour gérer le clic, le son ET la création des méduses -->
    <script>
        // Fonction pour activer/désactiver le son du logo
        function toggleLogoSound() {
            const logoElement = document.getElementById('clickable-logo');
            const soundButton = document.getElementById('sound-toggle-button');
            if (!logoElement || !soundButton) { console.error("Logo or sound button not found for toggle."); return; }
            const soundComponent = logoElement.components.sound;
            if (!soundComponent) { console.error("Sound component not found on logo."); return; }
            const sceneEl = document.querySelector('a-scene');
            const audioContext = sceneEl?.audioListener?.context;
            if (audioContext && audioContext.state === 'suspended') {
                audioContext.resume().catch(e => console.error("Error resuming audio context", e));
            }
            if (soundComponent.isPlaying) {
                soundComponent.pauseSound(); soundButton.textContent = "Play Sound";
            } else {
                soundComponent.playSound(); soundButton.textContent = "Pause Sound";
            }
        }

        // NOUVEAU : Fonction pour créer plusieurs instances de méduses
        function createJellyfishInstances() {
            const sceneEl = document.querySelector('#ar-scene');
            if (!sceneEl) { console.error("Scene element #ar-scene not found!"); return; }

            const jellyfishPositions = [
                { x: -1,  y: 2,   z: -2.5 },
                { x: 1.8, y: 1.8, z: -3.8 },
                { x: -1.5,y: 1.5, z: -4.2 },
                { x: 0.8, y: 2.2, z: -3.0 } // Ajout d'une 4ème pour l'exemple
            ];
            const baseScale = 0.3;
            const baseAnimDurPos = 12000;
            const baseAnimDurRot = 20000;

            jellyfishPositions.forEach((pos, index) => {
                const jellyfish = document.createElement('a-gltf-model');
                jellyfish.setAttribute('id', `jellyfish-${index + 1}`);
                jellyfish.setAttribute('src', '#jellyfishModel');
                jellyfish.setAttribute('position', `${pos.x} ${pos.y} ${pos.z}`);
                const scaleVar = baseScale * (0.9 + Math.random() * 0.2);
                jellyfish.setAttribute('scale', `${scaleVar} ${scaleVar} ${scaleVar}`);
                jellyfish.setAttribute('rotation', `0 ${Math.random() * 360} 0`);
                jellyfish.setAttribute('animation-mixer', 'clip: *; loop: repeat');
                let fromPos = `${pos.x} ${pos.y} ${pos.z}`;
                let toX = pos.x + (Math.random() - 0.5) * 1.5;
                let toY = pos.y + (Math.random() * 0.6 + 0.3);
                let toZ = pos.z + (Math.random() - 0.5) * 1.5;
                let toPos = `${toX} ${toY} ${toZ}`;
                let durPos = baseAnimDurPos * (0.8 + Math.random() * 0.4);
                jellyfish.setAttribute(`animation__pos`, `property: position; from: ${fromPos}; to: ${toPos}; dir: alternate; dur: ${durPos}; easing: easeInOutSine; loop: true;`);
                let rotY = Math.random() > 0.5 ? 360 : -360;
                let durRot = baseAnimDurRot * (0.8 + Math.random() * 0.4);
                jellyfish.setAttribute(`animation__rot`, `property: rotation; to: 0 ${rotY} 0; dur: ${durRot}; easing: linear; loop: true;`);
                sceneEl.appendChild(jellyfish);
                console.log(`Created jellyfish-${index + 1} at ${pos.x}, ${pos.y}, ${pos.z}`);
            });
        }

        // Attendre que la scène soit chargée pour initialiser
        document.addEventListener('DOMContentLoaded', () => {
            const sceneEl = document.querySelector('a-scene');

            sceneEl.addEventListener('loaded', () => {
                console.log("A-Frame scene loaded. Initializing elements...");

                // Récupérer les éléments pour les clics
                const clickableLogo = document.getElementById('clickable-logo');
                const clickableWangMeng = document.getElementById('clickable-wangmeng');
                const messagePopup = document.getElementById('message-popup');

                // Ajouter les écouteurs de clic pour les images et le popup
                if (clickableLogo && clickableWangMeng && messagePopup) {
                    console.log("Adding click listeners for images and popup.");
                    clickableLogo.addEventListener('click', () => {
                        messagePopup.textContent = "bonjour"; messagePopup.style.display = 'block';
                    });
                    clickableWangMeng.addEventListener('click', () => {
                        messagePopup.textContent = "bye"; messagePopup.style.display = 'block';
                    });
                    messagePopup.addEventListener('click', () => { messagePopup.style.display = 'none'; });
                } else {
                    if (!clickableLogo) console.error("Clickable logo not found!");
                    if (!clickableWangMeng) console.error("Clickable Wang Meng not found!");
                    if (!messagePopup) console.error("Message popup not found!");
                }

                // Activer le bouton Son
                const soundButton = document.getElementById('sound-toggle-button');
                const logoElementExists = document.getElementById('clickable-logo');
                if (soundButton && logoElementExists) {
                    console.log("Activating sound toggle button.");
                    soundButton.style.display = 'block';
                    soundButton.addEventListener('click', toggleLogoSound);
                } else {
                    if (!soundButton) console.error("Sound toggle button not found!");
                    if (!logoElementExists) console.error("Logo element not found for sound button activation!");
                }

                // Créer les instances de méduses
                console.log("Creating jellyfish instances...");
                createJellyfishInstances();

                console.log("Initialization complete.");
            }); // Fin de sceneEl.addEventListener('loaded')
        }); // Fin de document.addEventListener('DOMContentLoaded')
    </script>

</body>
</html>
