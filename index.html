<!DOCTYPE html>
<html>
<head>
    <title>AURALIS AR Experience (Asset Count Progress)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="AURALIS AR Experience using A-Frame and AR.js with asset count progress indicator.">
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <style>
        /* Styles inchangés */
        body { margin: 0; overflow: hidden; }
        #wechat-notice { position: absolute; top: 10px; left: 10px; right: 10px; padding: 10px; background: rgba(0,0,0,0.7); color: white; z-index: 101; font-size: 14px; text-align: center; border-radius: 5px; }
        .arjs-loader { height: 100%; width: 100%; position: absolute; top: 0; left: 0; background-color: rgba(0, 0, 0, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 1; transition: opacity 0.5s ease-out; }
        .arjs-loader-message { text-align: center; font-size: 1.25em; color: white; margin-bottom: 15px; }
        #progress-text { color: #ccc; font-size: 1em; }
        #progress-text.error { color: #ff6b6b; }
    </style>
</head>
<body style='margin : 0px; overflow: hidden;'>
    <!-- WeChat Notice -->
    <div id="wechat-notice" onclick="this.style.display='none';">...</div>

    <!-- Loader -->
    <div class="arjs-loader" id="arjs-loader-div">
        <div class="arjs-loader-message">Chargement des éléments AURALIS...</div>
        <!-- Texte de progression basé sur le comptage -->
        <div id="progress-text">0/9</div>
    </div>

    <!-- Scène A-Frame -->
    <a-scene id="ar-scene" embedded arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'
        renderer='logarithmicDepthBuffer: true; colorManagement: true;' vr-mode-ui='enabled: false'>

        <!-- Assets -->
        <!-- Le timeout est moins critique pour la *logique* du loader maintenant, mais toujours utile comme filet de sécurité -->
        <a-assets timeout="120000">
             <img id="logoImg" src="images/logo.jpg" crossOrigin="anonymous">
             <img id="wangMengImg" src="images/wang_meng.jpg" crossOrigin="anonymous">
             <img id="yuMiaoImg" src="images/yu_miao.jpg" crossOrigin="anonymous">
             <img id="djBackImg" src="images/dj_back.jpg" crossOrigin="anonymous">
             <img id="stageWideImg" src="images/stage_wide.jpg" crossOrigin="anonymous">
             <img id="stageDuoBlueImg" src="images/stage_duo_blue.jpg" crossOrigin="anonymous">
             <img id="stageDuoDarkImg" src="images/stage_duo_dark.jpg" crossOrigin="anonymous">
             <audio id="logoSound" src="audio/your_sound.mp3" preload="auto" crossOrigin="anonymous"></audio>
             <a-asset-item id="jellyfishModel" src="models/meduse.glb" crossOrigin="anonymous"></a-asset-item>
        </a-assets>

        <!-- Contenu -->
        <a-entity id="content-container" position="0 1.5 -4.0" rotation="0 0 0" scale="1 1 1"></a-entity>
        <!-- Important: L'entité qui utilise le modèle doit avoir un ID pour qu'on puisse écouter son événement model-loaded -->
        <a-gltf-model id="jellyfish-entity" src="#jellyfishModel" position="-1 2 -2" scale="0.3 0.3 0.3" rotation="0 0 0"
                      animation__pos="property: position; from: -1 2 -2; to: 1 1.2 -1.5; dir: alternate; dur: 12000; easing: easeInOutSine; loop: true;"
                      animation__rot="property: rotation; to: 0 360 0; dur: 20000; easing: linear; loop: true;"
                      animation-mixer="clip: *; loop: repeat"></a-gltf-model>
        <a-camera cursor="rayOrigin: mouse; fuse: false;" raycaster="objects: [data-interactive]"></a-camera>
    </a-scene>

    <!-- Script -->
    <script>
        // --- Config (inchangée) ---
        const PANEL_BASE_WIDTH = 1.8; const PANEL_COLOR = '#1a1a3a'; const PANEL_OPACITY = 0.85;
        const BG_Z_OFFSET = -0.01; const IMAGE_Z_OFFSET = 0;
        const imagePositions = { /* ... */
            'logoImg':         { x: 0,    y: 0,    z: 0.1 }, 'wangMengImg':     { x: -2.2, y: 2,  z: -0.1 },
            'yuMiaoImg':       { x: 2.2,  y: 0.4,  z: -0.1 }, 'stageWideImg':    { x: 0,    y: 2,  z: -0.3 },
            'djBackImg':       { x: 0,    y: -2, z: -0.2 }, 'stageDuoBlueImg': { x: -2.5, y: -0.8, z: 0.2 },
            'stageDuoDarkImg': { x: 2.5,  y: -0.8, z: 0.2 },
         };
        const contentData = [ /* ... */
             { type: 'image', srcId: 'logoImg', originalWidth: 2, originalHeight: 2 }, { type: 'image', srcId: 'wangMengImg', originalWidth: 1, originalHeight: 1.2 },
             { type: 'image', srcId: 'yuMiaoImg', originalWidth: 1.5, originalHeight: 1 }, { type: 'image', srcId: 'stageWideImg', originalWidth: 2, originalHeight: 1.1 },
             { type: 'image', srcId: 'djBackImg', originalWidth: 1, originalHeight: 1.25 }, { type: 'image', srcId: 'stageDuoBlueImg', originalWidth: 1.8, originalHeight: 1.1 },
             { type: 'image', srcId: 'stageDuoDarkImg', originalWidth: 1.8, originalHeight: 1.1 }
         ];

        // --- Fonctions create/setup (inchangées) ---
        function createImagePanel(itemData, position) { /* ... */ } // Code non montré pour brièveté
        function setupManualLayout() { /* ... */ } // Code non montré pour brièveté

        // --- LOGIQUE DE CHARGEMENT PAR COMPTAGE D'ASSETS ---
        document.addEventListener('DOMContentLoaded', () => {
            const totalAssetCount = 9; // 7 images + 1 audio + 1 modèle
            let loadedAssetCount = 0;
            let loaderHidden = false; // Pour éviter de cacher plusieurs fois
            let setupLayoutCalled = false; // Pour appeler setup une seule fois

            const progressText = document.getElementById('progress-text');
            const loaderDiv = document.getElementById('arjs-loader-div');
            const sceneEl = document.querySelector('a-scene');
            const assetsEl = document.querySelector('a-assets'); // Pour l'écouteur timeout

            // --- IDs des assets à suivre ---
            const imageIds = ['logoImg', 'wangMengImg', 'yuMiaoImg', 'djBackImg', 'stageWideImg', 'stageDuoBlueImg', 'stageDuoDarkImg'];
            const audioId = 'logoSound';
            const modelEntityId = 'jellyfish-entity'; // ID de l'entité <a-gltf-model>

            // --- Fonction pour mettre à jour la progression ---
            function assetLoaded() {
                if (loaderHidden) return; // Ne rien faire si le loader est déjà caché

                loadedAssetCount++;
                console.log(`Asset loaded! Count: ${loadedAssetCount}/${totalAssetCount}`);
                progressText.textContent = `${loadedAssetCount}/${totalAssetCount}`;

                // Vérifier si tous les assets sont chargés
                if (loadedAssetCount >= totalAssetCount) {
                    console.log('All assets counted as loaded. Hiding loader soon...');
                    loaderHidden = true; // Marquer comme caché pour éviter répétition
                    // Optionnel : Délai supplémentaire pour le rendu final
                    const hideDelay = 500; // Plus court délai possible maintenant
                    setTimeout(() => {
                         console.log('Hiding loader now.');
                         loaderDiv.style.opacity = '0';
                         setTimeout(() => { loaderDiv.style.display = 'none'; }, 500);
                    }, hideDelay);
                }
            }

            // --- Écouteurs pour chaque asset ---

            // Images
            imageIds.forEach(id => {
                const img = document.getElementById(id);
                if (img) {
                    if (img.complete) { // Déjà chargé (cache)?
                        console.log(`Image ${id} was already complete.`);
                        assetLoaded();
                    } else {
                        img.addEventListener('load', assetLoaded, { once: true });
                        img.addEventListener('error', () => {
                             console.error(`Failed to load image: ${id}`);
                             // Optionnel: Gérer l'erreur (compter comme chargé? afficher erreur?)
                             // Pour l'instant, on ne compte pas, le total ne sera pas atteint
                        }, { once: true });
                    }
                } else {
                    console.warn(`Image element with ID ${id} not found.`);
                }
            });

            // Audio
            const audio = document.getElementById(audioId);
            if (audio) {
                // readyState 4 = HAVE_ENOUGH_DATA
                if (audio.readyState >= 4) {
                    console.log(`Audio ${audioId} was already ready (readyState >= 4).`);
                    assetLoaded();
                } else {
                    audio.addEventListener('canplaythrough', assetLoaded, { once: true });
                    audio.addEventListener('error', () => {
                        console.error(`Failed to load audio: ${audioId}`);
                    }, { once: true });
                }
            } else {
                console.warn(`Audio element with ID ${audioId} not found.`);
            }

            // Modèle 3D (écouteur sur l'entité qui l'utilise)
            // Doit attendre que la scène soit un minimum chargée pour que l'entité existe
            function setupModelListener() {
                const modelEntity = document.getElementById(modelEntityId);
                if (modelEntity) {
                    console.log(`Setting up listener for model-loaded on ${modelEntityId}`);
                    modelEntity.addEventListener('model-loaded', assetLoaded, { once: true });
                    // Note: L'événement 'error' sur gltf-model est moins standardisé,
                    // on se fie au timeout global pour les erreurs de modèle.
                } else {
                    console.warn(`Model entity ${modelEntityId} not found yet. Will retry if scene loads.`);
                    // Si la scène charge après ce point, l'écouteur scene.loaded tentera à nouveau
                }
            }

            // --- Filet de Sécurité : Timeout Global ---
            let timeoutOccurred = false;
            assetsEl.addEventListener('timeout', () => {
                if (timeoutOccurred || loaderHidden) return;
                timeoutOccurred = true;
                console.error(`!!!!! Assets loading timed out via <a-assets> !!!!!`);
                progressText.textContent = `Erreur Timeout (${loadedAssetCount}/${totalAssetCount})`;
                progressText.classList.add('error');
                // Ne pas masquer le loader
            }, { once: true });


            // --- La scène est prête (pour setup layout et listener modèle) ---
            sceneEl.addEventListener('loaded', () => {
                console.log(">>> Scene 'loaded' event fired.");
                if (!setupLayoutCalled) {
                    setupManualLayout();
                    setupLayoutCalled = true;
                }
                 // Essayer d'attacher le listener du modèle ici, au cas où l'entité serait prête
                 // L'option {once: true} empêche l'ajout multiple si on l'appelle à nouveau
                 setupModelListener();
            });

            // Gérer si scène déjà chargée + attacher listener modèle
            if (sceneEl.hasLoaded) {
                console.log("Scene was already loaded on DOMContentLoaded.");
                 if (!setupLayoutCalled) {
                    setupManualLayout();
                    setupLayoutCalled = true;
                 }
                setupModelListener();
            } else {
                // Essayer d'attacher le listener modèle tôt au cas où
                // Il est possible que l'entité soit créée avant l'événement 'loaded' complet
                setTimeout(setupModelListener, 100); // Petit délai pour laisser A-Frame initialiser un peu
            }


        }); // Fin DOMContentLoaded
    </script>
</body>
</html>
