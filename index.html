<!DOCTYPE html>
<html>
<head>
    <title>AURALIS AR Experience (Manual Image Layout)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="AURALIS AR Experience using A-Frame and AR.js with manually defined image layout and progress bar.">
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <style>
        <!-- AVERTISSEMENT : Utiliser <!-- --> ici est incorrect pour CSS. Utilisez /* ... */ -->
        body { margin: 0; overflow: hidden; }
        #wechat-notice { position: absolute; top: 10px; left: 10px; right: 10px; padding: 10px; background: rgba(0,0,0,0.7); color: white; z-index: 101; font-size: 14px; text-align: center; border-radius: 5px; }

        <!-- --- Styles de l'écran de chargement et de la barre de progression --- -->
        .arjs-loader {
            height: 100%;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            background-color: rgba(0, 0, 0, 0.9); <!-- Légèrement plus sombre -->
            z-index: 9999;
            display: flex; <!-- Utiliser flexbox pour centrer -->
            justify-content: center;
            align-items: center;
            flex-direction: column; <!-- Aligner les éléments verticalement -->
            opacity: 1; <!-- Start visible -->
            transition: opacity 0.5s ease-out; <!-- Add fade-out transition -->
        }
        .arjs-loader-message { <!-- Style pour le message texte -->
            text-align: center;
            font-size: 1.25em;
            color: white;
            margin-bottom: 20px; <!-- Espace sous le texte -->
        }
        #progress-bar-container {
            width: 80%; <!-- Largeur de la barre -->
            max-width: 300px; <!-- Largeur maximale -->
            height: 20px; <!-- Hauteur de la barre -->
            background-color: #333; <!-- Couleur de fond de la barre -->
            border-radius: 10px; <!-- Coins arrondis -->
            overflow: hidden; <!-- Masquer ce qui dépasse -->
            border: 1px solid #555;
        }
        #progress-bar-fill {
            width: 0%; <!-- Commence à 0% -->
            height: 100%;
            background-color: #4a90e2; <!-- Couleur de remplissage -->
            border-radius: 10px; <!-- Coins arrondis -->
            transition: width 0.3s ease-out; <!-- Animation douce -->
        }
         #progress-text {
            margin-top: 10px; <!-- Espace au-dessus du texte du pourcentage -->
            color: #ccc;
            font-size: 0.9em;
        }
    </style>
</head>
<body style='margin : 0px; overflow: hidden;'>
    <!-- --- Message pour WeChat --- -->
    <div id="wechat-notice" onclick="this.style.display='none';">
        <b>Note WeChat:</b> Pour l'expérience AR, cliquez sur '...' puis 'Ouvrir dans le navigateur'.
    </div>

    <!-- --- Écran de chargement AR.js avec Barre de Progression --- -->
    <div class="arjs-loader" id="arjs-loader-div">
        <div class="arjs-loader-message">Chargement de l'expérience AURALIS...</div>
        <div id="progress-bar-container">
            <div id="progress-bar-fill"></div>
        </div>
        <div id="progress-text">0%</div> <!-- Texte pour le pourcentage -->
    </div>

    <!-- --- Scène A-Frame AR (Markerless) --- -->
    <a-scene
        id="ar-scene"
        embedded
        arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'
        renderer='logarithmicDepthBuffer: true; colorManagement: true;'
        vr-mode-ui='enabled: false'>

        <!-- --- Assets --- -->
        <!-- Timeout *FORTEMENT* augmenté pour test -->
        <a-assets timeout="180000">
             <img id="logoImg" src="images/logo.jpg" crossOrigin="anonymous">
             <img id="wangMengImg" src="images/wang_meng.jpg" crossOrigin="anonymous">
             <img id="yuMiaoImg" src="images/yu_miao.jpg" crossOrigin="anonymous">
             <img id="djBackImg" src="images/dj_back.jpg" crossOrigin="anonymous">
             <img id="stageWideImg" src="images/stage_wide.jpg" crossOrigin="anonymous">
             <img id="stageDuoBlueImg" src="images/stage_duo_blue.jpg" crossOrigin="anonymous">
             <img id="stageDuoDarkImg" src="images/stage_duo_dark.jpg" crossOrigin="anonymous">

            <!-- Audio Asset -->
             <audio id="logoSound" src="audio/your_sound.mp3" preload="auto" crossOrigin="anonymous"></audio>

            <!-- Modèle 3D -->
             <a-asset-item id="jellyfishModel" src="models/meduse.glb" crossOrigin="anonymous"></a-asset-item>
        </a-assets>

        <!-- --- Conteneur pour les panneaux (Ancre globale) --- -->
        <a-entity id="content-container" position="0 1.5 -4.0" rotation="0 0 0" scale="1 1 1">
            <!-- Les panneaux image seront ajoutés ici selon les positions définies en JS -->
        </a-entity>

        <!-- Méduse 3D Animée -->
        <a-gltf-model id="jellyfish"
                      src="#jellyfishModel"
                      position="-1 2 -2"
                      scale="0.3 0.3 0.3"
                      rotation="0 0 0"
                      animation__pos="property: position; from: -1 2 -2; to: 1 1.2 -1.5; dir: alternate; dur: 12000; easing: easeInOutSine; loop: true;"
                      animation__rot="property: rotation; to: 0 360 0; dur: 20000; easing: linear; loop: true;"
                      animation-mixer="clip: *; loop: repeat"
                      visible="false" <!-- Start hidden until loaded -->
                      >
        </a-gltf-model>

        <!-- --- Caméra --- -->
        <a-camera cursor="rayOrigin: mouse; fuse: false;" raycaster="objects: [data-interactive]"></a-camera>

    </a-scene>

    <!-- --- Script pour générer le contenu ET gérer la progression --- -->
    <script>
        <!-- AVERTISSEMENT : Utiliser <!-- --> ici est incorrect pour JavaScript. Utilisez // ou /* ... */ -->

        <!-- --- Configuration --- -->
        const PANEL_BASE_WIDTH = 1.8;         <!-- Largeur standard panneau image -->
        const PANEL_COLOR = '#1a1a3a';
        const PANEL_OPACITY = 0.85;
        const BG_Z_OFFSET = -0.01;            <!-- Décalage Z du fond -->
        const IMAGE_Z_OFFSET = 0;             <!-- Position Z de l'image -->

        const imagePositions = {
            'logoImg':         { x: 0,    y: 0,    z: 0.1 },
            'wangMengImg':     { x: -2.2, y: 2,  z: -0.1 },
            'yuMiaoImg':       { x: 2.2,  y: 0.4,  z: -0.1 },
            'stageWideImg':    { x: 0,    y: 2,  z: -0.3 },
            'djBackImg':       { x: 0,    y: -2, z: -0.2 },
            'stageDuoBlueImg': { x: -2.5, y: -0.8, z: 0.2 },
            'stageDuoDarkImg': { x: 2.5,  y: -0.8, z: 0.2 },
        };

        const contentData = [
            { type: 'image', srcId: 'logoImg', originalWidth: 2, originalHeight: 2 },
            { type: 'image', srcId: 'wangMengImg', originalWidth: 1, originalHeight: 1.2 },
            { type: 'image', srcId: 'yuMiaoImg', originalWidth: 1.5, originalHeight: 1 },
            { type: 'image', srcId: 'stageWideImg', originalWidth: 2, originalHeight: 1.1 },
            { type: 'image', srcId: 'djBackImg', originalWidth: 1, originalHeight: 1.25 },
            { type: 'image', srcId: 'stageDuoBlueImg', originalWidth: 1.8, originalHeight: 1.1 },
            { type: 'image', srcId: 'stageDuoDarkImg', originalWidth: 1.8, originalHeight: 1.1 }
        ];

        let assetsFullyLoaded = false; <!-- Flag to track asset loading status -->

        <!-- --- Fonction createImagePanel --- -->
        function createImagePanel(itemData, position) {
            const container = document.getElementById('content-container');
            if (!container || !itemData || itemData.type !== 'image' || !itemData.srcId) return null;
            const imgElement = document.getElementById(itemData.srcId);

             const originalWidth = itemData.originalWidth || imgElement?.naturalWidth;
             const originalHeight = itemData.originalHeight || imgElement?.naturalHeight;

             <!-- If assets haven't fully loaded, we might still have issues here -->
             if (!imgElement || !originalWidth || !originalHeight) {
                <!-- Only warn if assets were supposed to be loaded -->
                if (assetsFullyLoaded) {
                    console.warn(`Asset/dimensions missing or invalid for ${itemData.srcId} even after load event.`);
                } else {
                    <!-- Expected issue if timeout occurred before creation -->
                     console.log(`Asset/dimensions not ready yet for ${itemData.srcId} (likely due to loading state).`);
                }
                <!-- Optionally return null or create a placeholder -->
                return null;
             }

            const entity = document.createElement('a-entity');
            entity.setAttribute('visible', false); <!-- Start invisible, make visible later -->

            const aspect = originalWidth / originalHeight;
            const panelWidth = PANEL_BASE_WIDTH;
            const panelHeight = panelWidth / aspect;

            entity.setAttribute('animation__scaleup', `property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200; easing: easeOutQuad;`);
            entity.setAttribute('animation__scaledown', `property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200; easing: easeInQuad;`);
            entity.setAttribute('data-interactive', '');

            const imgBgPlane = document.createElement('a-plane');
            imgBgPlane.setAttribute('width', panelWidth * 1.05);
            imgBgPlane.setAttribute('height', panelHeight * 1.05);
            imgBgPlane.setAttribute('material', `color: ${PANEL_COLOR}; opacity: ${PANEL_OPACITY}; shader: flat;`);
            imgBgPlane.setAttribute('position', `0 0 ${BG_Z_OFFSET - 0.005}`);
            entity.appendChild(imgBgPlane);

            const imgPlane = document.createElement('a-plane');
            imgPlane.setAttribute('width', panelWidth);
            imgPlane.setAttribute('height', panelHeight);
            <!-- Use the check for loaded status before setting src directly? Might be complex. -->
            <!-- Relying on A-Frame/Three.js to handle it once image is loaded is typical. -->
            imgPlane.setAttribute('material', `src: #${itemData.srcId}; shader: flat; transparent: true;`);
            imgPlane.setAttribute('position', `0 0 ${IMAGE_Z_OFFSET}`);
            entity.appendChild(imgPlane);


            if (itemData.srcId === 'logoImg') {
                 <!-- We'll handle sound activation later, after confirming load -->
                 console.log(`Sound component setup planned for logoImg panel.`);
            }

            entity.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
            container.appendChild(entity);

            return entity;
        }

        <!-- --- Fonction setupManualLayout --- -->
        function setupManualLayout() {
            const container = document.getElementById('content-container');
             const jellyfish = document.getElementById('jellyfish');
            if (!container) { console.error("Could not find #content-container entity."); return; }
            while (container.firstChild) { container.removeChild(container.firstChild); }

            let allPanelsCreated = true;
            contentData.forEach(item => {
                if (item.type === 'image' && item.srcId && imagePositions[item.srcId]) {
                    const position = imagePositions[item.srcId];
                    const panel = createImagePanel(item, position);
                     if (!panel) allPanelsCreated = false; <!-- Track if any panel failed -->
                } else if (item.type === 'image' && item.srcId) {
                    console.warn(`Position not defined in imagePositions for ${item.srcId}. Panel not created.`);
                }
            });

             <!-- Make panels and jellyfish visible only if assets are likely loaded -->
             if (assetsFullyLoaded && allPanelsCreated) {
                 console.log("Manual image layout generated. Making content visible.");
                 container.querySelectorAll('a-entity').forEach(el => el.setAttribute('visible', true));
                 if (jellyfish) jellyfish.setAttribute('visible', true);

                 <!-- Activate sound only now -->
                 const logoPanel = container.querySelector(`[material*="src: #logoImg"]`)?.parentElement;
                 if (logoPanel) {
                     logoPanel.setAttribute('sound', {
                         src: '#logoSound',
                         autoplay: true, <!-- Or trigger on interaction if preferred -->
                         loop: true,
                         volume: 0.8,
                         positional: true,
                         distanceModel: 'inverse',
                         refDistance: 1,
                         rolloffFactor: 1
                     });
                     console.log(`Activated sound for logoImg panel.`);
                 }

             } else if (!assetsFullyLoaded) {
                 console.warn("Manual layout setup called, but assets did not fully load. Content might be incomplete or invisible.");
                 <!-- Optionally display an error message to the user here instead of hiding the loader -->
                 <!-- document.querySelector('.arjs-loader-message').textContent = "Erreur de chargement des ressources."; -->
                 <!-- loaderDiv.style.opacity = '1'; --> <!-- Keep loader visible -->
                 <!-- return; --> <!-- Prevent hiding loader if assets failed -->
             } else {
                 console.warn("Manual layout setup called, some panels failed to create. Content might be incomplete.");
             }
        }


        <!-- --- Gestion de la barre de progression et du chargement --- -->
        document.addEventListener('DOMContentLoaded', () => {
            const assets = document.querySelector('a-assets');
            const progressBarFill = document.getElementById('progress-bar-fill');
            const progressText = document.getElementById('progress-text');
            const loaderDiv = document.getElementById('arjs-loader-div');
            const sceneEl = document.querySelector('a-scene');
            const loaderMessage = document.querySelector('.arjs-loader-message');

            if (!assets || !progressBarFill || !progressText || !loaderDiv || !sceneEl || !loaderMessage) {
                console.error("Loader/Progress bar elements not found!");
                if(loaderDiv) loaderDiv.style.display = 'none';
                return;
            }

            let progressTimeout = null;

            <!-- --- Mettre à jour la barre de progression --- -->
            assets.addEventListener('progress', (event) => {
                <!-- Clear any previous timeout check -->
                clearTimeout(progressTimeout);

                const progress = event.detail.progress; <!-- Valeur entre 0 et 1 -->
                const percentage = Math.round(progress * 100);
                progressBarFill.style.width = percentage + '%';
                progressText.textContent = percentage + '%';
                console.log('Assets loading progress:', percentage, '%'); <!-- <-- LOG ACTIVÉ -->

                <!-- Set a timeout to check if progress stalls -->
                progressTimeout = setTimeout(() => {
                    console.warn('Asset progress seems to have stalled.');
                    <!-- Optionally update the message -->
                    <!-- loaderMessage.textContent = 'Chargement lent, veuillez patienter...'; -->
                }, 15000); <!-- 15 seconds without progress update = warning -->
            });

             <!-- --- Événement quand TOUS les assets sont chargés (AVANT le timeout) --- -->
             assets.addEventListener('loaded', () => {
                 <!-- Clear stall check -->
                 clearTimeout(progressTimeout);
                 console.log(">>>> A-Assets 'loaded' event fired! Assets should be ready.");
                 assetsFullyLoaded = true;
                 <!-- Ensure bar is visually 100% -->
                 progressBarFill.style.width = '100%';
                 progressText.textContent = '100%';
             });

             <!-- --- Gestion d'erreur de chargement/timeout des assets --- -->
             assets.addEventListener('timeout', (event) => {
                  <!-- Clear stall check -->
                 clearTimeout(progressTimeout);
                 console.error("!!!!! A-Assets timed out !!!!!", event.detail.src);
                 assetsFullyLoaded = false; <!-- Mark as not loaded -->
                 loaderMessage.textContent = "Erreur: Le chargement a dépassé le délai.";
                 <!-- Garder le loader visible ou afficher un message permanent -->
                 progressBarFill.style.backgroundColor = 'red'; <!-- Indicate error -->
                 progressText.textContent = 'Timeout!';
                 <!-- Ne pas masquer le loader automatiquement dans ce cas -->
             });

             <!-- --- Cacher le loader quand la SCENE est prête ET idéalement assets chargés --- -->
            sceneEl.addEventListener('loaded', () => {
                 console.log("A-Frame scene 'loaded' event fired.");

                 <!-- Appeler setupManualLayout pour créer les entités -->
                 <!-- setupManualLayout maintenant gère la visibilité basée sur assetsFullyLoaded -->
                 setupManualLayout();

                 <!-- Masquer le loader SEULEMENT si les assets ont chargé SANS timeout -->
                 if (assetsFullyLoaded) {
                     console.log("Assets loaded successfully, hiding loader.");
                     <!-- Petit délai pour voir le 100% -->
                     setTimeout(() => {
                         loaderDiv.style.opacity = '0';
                         setTimeout(() => { loaderDiv.style.display = 'none'; }, 500);
                     }, 300); <!-- Short delay -->
                 } else {
                     console.warn("Scene loaded, but assets timed out or failed. Loader kept visible (or modified).");
                     <!-- Le message d'erreur est déjà défini dans le handler 'timeout' -->
                 }
            });

        }); <!-- Fin de DOMContentLoaded -->

    </script>
</body>
</html>
