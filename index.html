<!DOCTYPE html>
<html>
<head>
    <title>AURALIS AR Experience (Delayed Hide & Safer Timeout)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="AURALIS AR Experience using A-Frame and AR.js, loader driven by asset events with delayed hiding and safer timeout handling.">
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <style>
        /* Styles inchangés */
        body { margin: 0; overflow: hidden; }
        #wechat-notice { position: absolute; top: 10px; left: 10px; right: 10px; padding: 10px; background: rgba(0,0,0,0.7); color: white; z-index: 101; font-size: 14px; text-align: center; border-radius: 5px; }
        .arjs-loader { height: 100%; width: 100%; position: absolute; top: 0; left: 0; background-color: rgba(0, 0, 0, 0.9); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 1; transition: opacity 0.5s ease-out; }
        .arjs-loader-message { text-align: center; font-size: 1.25em; color: white; margin-bottom: 15px; }
        #progress-text { color: #ccc; font-size: 1em; }
        /* La classe error n'est plus utilisée pour le moment
           #progress-text.error { color: #ff6b6b; } */
    </style>
</head>
<body style='margin : 0px; overflow: hidden;'>
    <!-- WeChat Notice -->
    <div id="wechat-notice" onclick="this.style.display='none';">...</div>

    <!-- Loader -->
    <div class="arjs-loader" id="arjs-loader-div">
        <div class="arjs-loader-message">Chargement de l'expérience AURALIS...</div>
        <div id="progress-text">0%</div>
    </div>

    <!-- Scène A-Frame -->
    <a-scene id="ar-scene" embedded arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'
        renderer='logarithmicDepthBuffer: true; colorManagement: true;' vr-mode-ui='enabled: false'>

        <!-- Assets -->
        <!-- Augmenter légèrement le timeout peut aider Safari, mais l'optimisation reste clé -->
        <a-assets timeout="120000"> <!-- Essayer 120 secondes -->
             <img id="logoImg" src="images/logo.jpg" crossOrigin="anonymous">
             <img id="wangMengImg" src="images/wang_meng.jpg" crossOrigin="anonymous">
             <img id="yuMiaoImg" src="images/yu_miao.jpg" crossOrigin="anonymous">
             <img id="djBackImg" src="images/dj_back.jpg" crossOrigin="anonymous">
             <img id="stageWideImg" src="images/stage_wide.jpg" crossOrigin="anonymous">
             <img id="stageDuoBlueImg" src="images/stage_duo_blue.jpg" crossOrigin="anonymous">
             <img id="stageDuoDarkImg" src="images/stage_duo_dark.jpg" crossOrigin="anonymous">
             <audio id="logoSound" src="audio/your_sound.mp3" preload="auto" crossOrigin="anonymous"></audio>
             <a-asset-item id="jellyfishModel" src="models/meduse.glb" crossOrigin="anonymous"></a-asset-item>
        </a-assets>

        <!-- Contenu -->
        <a-entity id="content-container" position="0 1.5 -4.0" rotation="0 0 0" scale="1 1 1"></a-entity>
        <a-gltf-model id="jellyfish" src="#jellyfishModel" position="-1 2 -2" scale="0.3 0.3 0.3" rotation="0 0 0"
                      animation__pos="..." animation__rot="..." animation-mixer="..."></a-gltf-model>
        <a-camera cursor="rayOrigin: mouse; fuse: false;" raycaster="objects: [data-interactive]"></a-camera>
    </a-scene>

    <!-- Script -->
    <script>
        // --- Config (inchangée) ---
        const PANEL_BASE_WIDTH = 1.8; const PANEL_COLOR = '#1a1a3a'; const PANEL_OPACITY = 0.85;
        const BG_Z_OFFSET = -0.01; const IMAGE_Z_OFFSET = 0;
        const imagePositions = { /* ... */
            'logoImg':         { x: 0,    y: 0,    z: 0.1 }, 'wangMengImg':     { x: -2.2, y: 2,  z: -0.1 },
            'yuMiaoImg':       { x: 2.2,  y: 0.4,  z: -0.1 }, 'stageWideImg':    { x: 0,    y: 2,  z: -0.3 },
            'djBackImg':       { x: 0,    y: -2, z: -0.2 }, 'stageDuoBlueImg': { x: -2.5, y: -0.8, z: 0.2 },
            'stageDuoDarkImg': { x: 2.5,  y: -0.8, z: 0.2 },
         };
        const contentData = [ /* ... */
             { type: 'image', srcId: 'logoImg', originalWidth: 2, originalHeight: 2 }, { type: 'image', srcId: 'wangMengImg', originalWidth: 1, originalHeight: 1.2 },
             { type: 'image', srcId: 'yuMiaoImg', originalWidth: 1.5, originalHeight: 1 }, { type: 'image', srcId: 'stageWideImg', originalWidth: 2, originalHeight: 1.1 },
             { type: 'image', srcId: 'djBackImg', originalWidth: 1, originalHeight: 1.25 }, { type: 'image', srcId: 'stageDuoBlueImg', originalWidth: 1.8, originalHeight: 1.1 },
             { type: 'image', srcId: 'stageDuoDarkImg', originalWidth: 1.8, originalHeight: 1.1 }
        ];

        // --- Fonctions create/setup (inchangées) ---
        function createImagePanel(itemData, position) { /* ... code inchangé ... */
            const container = document.getElementById('content-container');
            if (!container || !itemData || itemData.type !== 'image' || !itemData.srcId) return null;
            const imgElement = document.getElementById(itemData.srcId);
            const originalWidth = itemData.originalWidth || imgElement?.naturalWidth;
            const originalHeight = itemData.originalHeight || imgElement?.naturalHeight;
            const entity = document.createElement('a-entity');
            const aspect = (originalWidth && originalHeight) ? originalWidth / originalHeight : 1;
            const panelWidth = PANEL_BASE_WIDTH;
            const panelHeight = aspect ? panelWidth / aspect : PANEL_BASE_WIDTH;
            entity.setAttribute('animation__scaleup', `property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200; easing: easeOutQuad;`);
            entity.setAttribute('animation__scaledown', `property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200; easing: easeInQuad;`);
            entity.setAttribute('data-interactive', '');
            const imgBgPlane = document.createElement('a-plane'); // Fond
            imgBgPlane.setAttribute('width', panelWidth * 1.05); imgBgPlane.setAttribute('height', panelHeight * 1.05);
            imgBgPlane.setAttribute('material', `color: ${PANEL_COLOR}; opacity: ${PANEL_OPACITY}; shader: flat;`);
            imgBgPlane.setAttribute('position', `0 0 ${BG_Z_OFFSET - 0.005}`);
            entity.appendChild(imgBgPlane);
            const imgPlane = document.createElement('a-plane'); // Image
            imgPlane.setAttribute('width', panelWidth); imgPlane.setAttribute('height', panelHeight);
            imgPlane.setAttribute('material', `src: #${itemData.srcId}; shader: flat; transparent: true;`);
            imgPlane.setAttribute('position', `0 0 ${IMAGE_Z_OFFSET}`);
            entity.appendChild(imgPlane);
            if (itemData.srcId === 'logoImg') { // Son
                entity.setAttribute('sound', { src: '#logoSound', autoplay: true, loop: true, volume: 0.8, positional: true, distanceModel: 'inverse', refDistance: 1, rolloffFactor: 1 });
                console.log(`Attempting to add sound component to logoImg panel.`);
            }
            entity.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
            container.appendChild(entity);
            return entity;
         }
        function setupManualLayout() { /* ... code inchangé ... */
            console.log("Setting up manual layout...");
            const container = document.getElementById('content-container');
            if (!container) { console.error("Could not find #content-container entity."); return; }
            while (container.firstChild) { container.removeChild(container.firstChild); } // Vider
            contentData.forEach(item => {
                if (item.type === 'image' && item.srcId && imagePositions[item.srcId]) {
                    createImagePanel(item, imagePositions[item.srcId]);
                } else if (item.type === 'image' && item.srcId) { console.warn(`Position non définie pour ${item.srcId}.`); }
            });
             console.log("Manual image layout setup finished.");
         }


        // --- LOGIQUE DE CHARGEMENT (avec délai masquage + gestion timeout modifiée) ---
        document.addEventListener('DOMContentLoaded', () => {
            const assets = document.querySelector('a-assets');
            const progressText = document.getElementById('progress-text');
            const loaderDiv = document.getElementById('arjs-loader-div');
            const sceneEl = document.querySelector('a-scene');

            if (!assets || !progressText || !loaderDiv || !sceneEl) { /* ... gestion erreur ... */ return; }

            let assetsHaveTimedOut = false;
            let assetsHaveLoaded = false; // Nouveau flag pour savoir si 'loaded' a été déclenché

            // --- Mise à jour du % ---
            assets.addEventListener('progress', (event) => {
                if (assetsHaveTimedOut || assetsHaveLoaded) return; // Ne pas mettre à jour si terminé (succès ou échec)

                let progress = NaN;
                if (event.detail && typeof event.detail.loadedBytes === 'number' && typeof event.detail.totalBytes === 'number' && event.detail.totalBytes > 0) {
                    progress = event.detail.loadedBytes / event.detail.totalBytes;
                } else if (event.detail && typeof event.detail.progress === 'number' && !isNaN(event.detail.progress)) {
                    progress = event.detail.progress;
                }

                if (!isNaN(progress) && progress >= 0) {
                    const clampedProgress = Math.min(progress, 1); // Clamp à 1 max
                    const percentage = Math.round(clampedProgress * 100);
                    // Vérifier à nouveau avant d'afficher
                    if (!isNaN(percentage)) {
                        progressText.textContent = percentage + '%';
                    }
                } else if (isNaN(progress)) {
                    console.warn('Could not determine progress from event detail:', event.detail);
                }
            });

            // --- SUCCÈS : Tous les assets téléchargés ---
            assets.addEventListener('loaded', () => {
                if (assetsHaveTimedOut) {
                    console.log('Assets "loaded" event fired, but a timeout previously occurred. Loader will remain visible.');
                    return; // Ne rien faire si un timeout a déjà eu lieu
                }
                if (assetsHaveLoaded) return; // Eviter exécution multiple

                console.log('>>>> Assets "loaded" event fired! Finalizing...');
                assetsHaveLoaded = true; // Marquer comme chargé
                progressText.textContent = '100%'; // Assurer 100%

                // **** NOUVEAU: Délai avant de masquer ****
                // Donner ~1.5 seconde au navigateur pour le rendu/textures
                const hideDelay = 1500;
                console.log(`Waiting ${hideDelay}ms before hiding loader to allow rendering...`);

                setTimeout(() => {
                    console.log('Hiding loader now.');
                    loaderDiv.style.opacity = '0';
                    // Masquer complètement après la transition CSS
                    setTimeout(() => { loaderDiv.style.display = 'none'; }, 500); // 500ms = durée transition CSS
                }, hideDelay);
            });

            // --- ÉCHEC : Timeout des assets ---
            assets.addEventListener('timeout', (event) => {
                // Ne traiter que le premier timeout
                if (assetsHaveTimedOut || assetsHaveLoaded) return;

                console.error(`!!!!! Assets "timeout" event fired after ${assets.getAttribute('timeout') || 'default'} ms !!!!!`);
                assetsHaveTimedOut = true; // Marquer le timeout

                // ** MODIFICATION ** : Ne pas changer le texte ici, laisser le % tel quel
                // progressText.textContent = 'Erreur de chargement (Timeout)';
                // progressText.classList.add('error');
                console.warn("Loader will remain visible due to asset timeout. Last progress shown was:", progressText.textContent);
                // Le loader reste visible, bloqué sur le dernier % affiché
            });

            // --- La scène est prête ---
            sceneEl.addEventListener('loaded', () => {
                console.log(">>> Scene 'loaded' event fired. Setting up layout.");
                // Toujours essayer de configurer le layout dès que la scène est prête
                setupManualLayout();
            });

             // Gérer si scène déjà chargée
             if (sceneEl.hasLoaded) {
                 console.log("Scene was already loaded on DOMContentLoaded. Setting up layout.");
                 setupManualLayout();
             }

        }); // Fin DOMContentLoaded
    </script>
</body>
</html>
