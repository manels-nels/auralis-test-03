<!DOCTYPE html>
<html>
<head>
    <title>AURALIS AR Experience (Entities First, Visible Later)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="AURALIS AR Experience: Create entities early, show on load complete.">
    <!-- Scripts A-Frame / AR.js -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <style>
        /* Styles inchangés */
        body { margin: 0; overflow: hidden; }
        .arjs-loader { height: 100%; width: 100%; position: absolute; top: 0; left: 0; background-color: rgba(0, 0, 0, 0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; flex-direction: column; opacity: 1; transition: opacity 0.5s ease-out; }
        .arjs-loader-message { text-align: center; font-size: 1.25em; color: white; margin-bottom: 15px; }
        #progress-counter { text-align: center; font-size: 1em; color: #ccc; }
        #wechat-notice { position: absolute; top: 10px; left: 10px; right: 10px; padding: 10px; background: rgba(0,0,0,0.7); color: white; z-index: 101; font-size: 14px; text-align: center; border-radius: 5px; }
    </style>
</head>
<body style='margin : 0px; overflow: hidden;'>
    <!-- WeChat Notice -->
    <div id="wechat-notice" onclick="this.style.display='none';">...</div>

    <!-- Loader -->
    <div class="arjs-loader" id="arjs-loader-div">
        <div class="arjs-loader-message">Chargement AURALIS Experience...</div>
        <div id="progress-counter">0/9</div>
    </div>

    <!-- Scène A-Frame AR -->
    <a-scene
        id="ar-scene"
        embedded
        arjs='sourceType: webcam; debugUIEnabled: false;'
        renderer='logarithmicDepthBuffer: true; colorManagement: true;'
        vr-mode-ui='enabled: false'>

        <!-- Assets -->
        <a-assets timeout="120000">
            <img id="logoImg" src="images/logo.jpg" crossOrigin="anonymous">
            <img id="wangMengImg" src="images/wang_meng.jpg" crossOrigin="anonymous">
            <img id="yuMiaoImg" src="images/yu_miao.jpg" crossOrigin="anonymous">
            <img id="djBackImg" src="images/dj_back.jpg" crossOrigin="anonymous">
            <img id="stageWideImg" src="images/stage_wide.jpg" crossOrigin="anonymous">
            <img id="stageDuoBlueImg" src="images/stage_duo_blue.jpg" crossOrigin="anonymous">
            <img id="stageDuoDarkImg" src="images/stage_duo_dark.jpg" crossOrigin="anonymous">
            <audio id="logoSound" src="audio/your_sound.mp3" preload="auto" crossOrigin="anonymous"></audio>
            <a-asset-item id="jellyfishModelAsset" src="models/meduse.glb" crossOrigin="anonymous"></a-asset-item>
        </a-assets>

        <!-- Conteneur pour les panneaux -->
        <a-entity id="content-container" position="0 1.5 -4.0" rotation="0 0 0" scale="1 1 1" visible="false"> <!-- Commence invisible -->
            <!-- Rempli par JS au chargement de la scène -->
        </a-entity>

        <!-- Modèle 3D -->
        <a-gltf-model id="jellyfish" src="#jellyfishModelAsset" position="-1 2 -2" scale="0.3 0.3 0.3" rotation="0 0 0"
                      animation__pos="..." animation__rot="..." animation-mixer="..."
                      visible="false"> <!-- Commence invisible -->
        </a-gltf-model>

        <a-camera cursor="..." raycaster="..."></a-camera>
    </a-scene>

    <!-- Script -->
    <script>
        // --- Configuration ---
        const PANEL_BASE_WIDTH = 1.8; const PANEL_COLOR = '#1a1a3a'; const PANEL_OPACITY = 0.85;
        const BG_Z_OFFSET = -0.01; const IMAGE_Z_OFFSET = 0;
        const imagePositions = { /* ... */ }; const contentData = [ /* ... */ ];

        // --- Variables Globales Loader ---
        const TOTAL_ASSET_COUNT_TARGET = 9;
        const loadedAssetIdsRegistry = new Set();
        let loaderIsHidden = false;
        let sceneLayoutReady = false; // Indique si setupManualLayout a tourné

        // --- Références DOM ---
        const progressCounterElement = document.getElementById('progress-counter');
        const loaderDivElement = document.getElementById('arjs-loader-div');
        const sceneElement = document.querySelector('a-scene');
        const assetsElement = document.querySelector('a-assets');
        const contentContainer = document.getElementById('content-container'); // Référence au conteneur
        const jellyfishEntity = document.getElementById('jellyfish'); // Référence à la méduse

        // --- Fonction pour créer UN panneau image (SIMPLE, sans force update) ---
        function createImagePanel(itemData, position) {
             // Vérifier si le conteneur existe
             if (!contentContainer) {
                 console.error("Content container non trouvé lors de la création du panneau.");
                 return null;
             }
            if (!itemData || itemData.type !== 'image' || !itemData.srcId) return null;

            const imgElement = document.getElementById(itemData.srcId);
             // Vérifier l'image source, mais ne pas bloquer si dimensions non prêtes
             const originalWidth = itemData.originalWidth || imgElement?.naturalWidth || 1;
             const originalHeight = itemData.originalHeight || imgElement?.naturalHeight || 1;
            if (!imgElement) { console.warn(`Image element #${itemData.srcId} not found.`); }

            const entity = document.createElement('a-entity');
            const aspect = originalWidth / originalHeight;
            const panelWidth = PANEL_BASE_WIDTH; const panelHeight = panelWidth / aspect;

            // Setup attributes
            entity.setAttribute('animation__scaleup', `property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200; easing: easeOutQuad;`);
            entity.setAttribute('animation__scaledown', `property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200; easing: easeInQuad;`);
            entity.setAttribute('data-interactive', '');
            entity.setAttribute('position', `${position.x} ${position.y} ${position.z}`);

            // Background plane
            const imgBgPlane = document.createElement('a-plane');
            imgBgPlane.setAttribute('width', panelWidth * 1.05); imgBgPlane.setAttribute('height', panelHeight * 1.05);
            imgBgPlane.setAttribute('material', `color: ${PANEL_COLOR}; opacity: ${PANEL_OPACITY}; shader: flat;`);
            imgBgPlane.setAttribute('position', `0 0 ${BG_Z_OFFSET - 0.005}`);
            entity.appendChild(imgBgPlane);

            // Image plane - A-Frame devrait gérer l'application de la texture maintenant
            const imgPlane = document.createElement('a-plane');
            imgPlane.setAttribute('width', panelWidth); imgPlane.setAttribute('height', panelHeight);
            imgPlane.setAttribute('material', `src: #${itemData.srcId}; shader: flat; transparent: true;`);
            imgPlane.setAttribute('position', `0 0 ${IMAGE_Z_OFFSET}`);
            entity.appendChild(imgPlane);

            // Sound
            if (itemData.srcId === 'logoImg') {
                 entity.setAttribute('sound', { src: '#logoSound', autoplay: true, loop: true, volume: 0.8, positional: true, distanceModel: 'inverse', refDistance: 1, rolloffFactor: 1 });
            }

            // Ajouter au conteneur
            contentContainer.appendChild(entity);
            return entity;
        }


        // --- Fonction pour créer le layout (appelée par scene.loaded) ---
        function setupManualLayout() {
             if (sceneLayoutReady) return; // Exécuter une seule fois
             console.log("Setting up manual layout (creating hidden entities)...");

             if (!contentContainer) { console.error("Content container not found."); return; }
             while (contentContainer.firstChild) { contentContainer.removeChild(contentContainer.firstChild); }

             contentData.forEach(item => {
                 if (item.type === 'image' && item.srcId && imagePositions[item.srcId]) {
                     createImagePanel(item, imagePositions[item.srcId]);
                 } else if (item.type === 'image') { console.warn(`Position undefined for ${item.srcId}.`); }
             });

             console.log("Manual image layout structure created (currently hidden).");
             sceneLayoutReady = true; // Marquer comme prêt

             // Vérifier si les assets sont DÉJÀ tous chargés à ce moment
             if (loadedAssetIdsRegistry.size >= TOTAL_ASSET_COUNT_TARGET) {
                  console.log("Assets were already loaded when layout finished. Showing content now.");
                  showContentAndHideLoader();
             }
         }

        // --- Fonction pour afficher le contenu et cacher le loader (appelée quand tout est prêt) ---
        function showContentAndHideLoader() {
            if (loaderIsHidden) return; // Déjà fait

            console.log("All assets loaded and layout ready. Making content visible and hiding loader.");

             // Rendre le conteneur d'images et la méduse visibles
             if (contentContainer) contentContainer.setAttribute('visible', 'true');
             if (jellyfishEntity) jellyfishEntity.setAttribute('visible', 'true');

            // Cacher le loader
            loaderIsHidden = true;
            progressCounterElement.textContent = `${TOTAL_ASSET_COUNT_TARGET}/${TOTAL_ASSET_COUNT_TARGET}`;
            setTimeout(() => {
                loaderDivElement.style.opacity = '0';
                setTimeout(() => { loaderDivElement.style.display = 'none'; }, 500);
            }, 100);
        }

        // --- Logique de comptage ---
        function registerAssetLoad(assetId) {
             if (loaderIsHidden || loadedAssetIdsRegistry.has(assetId)) return;

             loadedAssetIdsRegistry.add(assetId);
             const currentCount = loadedAssetIdsRegistry.size;
             console.log(`Asset loaded/reported: ${assetId} (${currentCount}/${TOTAL_ASSET_COUNT_TARGET})`);
             progressCounterElement.textContent = `${currentCount}/${TOTAL_ASSET_COUNT_TARGET}`;

             // Vérifier si c'est le dernier ET si le layout est prêt
             if (currentCount >= TOTAL_ASSET_COUNT_TARGET && sceneLayoutReady) {
                 showContentAndHideLoader();
             } else if (currentCount >= TOTAL_ASSET_COUNT_TARGET && !sceneLayoutReady) {
                 console.log("All assets reported loaded, waiting for layout setup to complete...");
             }
         }

        // --- Attacher les écouteurs ---
        document.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Loaded. Attaching asset listeners...");

             const setupAssetListener = (element, eventName, assetId, checkCondition) => {
                 if (!element) { console.error(`Asset element not found: ${assetId}.`); return; }
                 if (checkCondition(element) && !element.hasAttribute('data-load-registered')) {
                      element.setAttribute('data-load-registered', 'true');
                      registerAssetLoad(assetId);
                 } else if (!element.hasAttribute('data-load-registered')) {
                     const loadHandler = () => { /* ... */ }; // Handler inchangé
                     const errorHandler = () => { /* ... */ }; // Handler inchangé
                     element.addEventListener(eventName, loadHandler, { once: true });
                     element.addEventListener('error', errorHandler, { once: true });
                 }
             };

             // Images
             const imageIds = ['logoImg', 'wangMengImg', 'yuMiaoImg', 'djBackImg', 'stageWideImg', 'stageDuoBlueImg', 'stageDuoDarkImg'];
             imageIds.forEach(id => {
                 setupAssetListener(document.getElementById(id), 'load', id, (el) => el.complete);
             });

             // Audio
             const audioId = 'logoSound';
             setupAssetListener(document.getElementById(audioId), 'canplaythrough', audioId, (el) => el.readyState >= 4);

             // Modèle GLTF (via l'asset item)
             const modelAssetItemId = 'jellyfishModelAsset';
             setupAssetListener(document.getElementById(modelAssetItemId), 'loaded', modelAssetItemId, (el) => el.hasLoaded);


            // --- Timeout Global ---
            let timeoutHasOccurred = false;
            assetsElement?.addEventListener('timeout', () => {
                 if (timeoutHasOccurred || loaderIsHidden || mainSceneInitialized) return; // mainSceneInitialized renommé, devrait être showContentAndHideLoader appelé ? Non, utiliser loaderIsHidden est mieux.
                 if (timeoutHasOccurred || loaderIsHidden) return;

                 timeoutHasOccurred = true;
                 console.error(`!!!!! Assets loading timed out !!!!!`);
                 progressCounterElement.textContent = `Timeout (${loadedAssetIdsRegistry.size}/${TOTAL_ASSET_COUNT_TARGET})`;
                 // Forcer l'affichage même en cas de timeout ?
                 if (!loaderIsHidden) {
                      console.warn("Timeout occurred. Forcing content display with potentially missing assets...");
                       // Attendre que le layout soit potentiellement prêt (si scene.loaded se déclenche)
                      setTimeout(() => {
                          if (sceneLayoutReady) { // Afficher seulement si le layout a été créé
                              showContentAndHideLoader();
                          } else {
                               console.error("Timeout, and layout never became ready. Cannot show content.");
                               // Laisser le message de timeout affiché
                          }
                      }, 1000); // Donner 1s
                 }
            }, { once: true });

            // --- Événement Scene Loaded (Re-devient important pour créer le layout) ---
             sceneElement.addEventListener('loaded', () => {
                 console.log(">>> Scene 'loaded' event fired. Running setupManualLayout.");
                 // Appeler setupManualLayout seulement si pas déjà fait
                 if (!sceneLayoutReady) {
                      setupManualLayout(); // Crée les entités cachées et met sceneLayoutReady = true
                 }
                 // Pas besoin de vérifier le compteur ici, registerAssetLoad ou setupManualLayout s'en chargera
             });

             // Gérer si scène déjà chargée
             if (sceneElement.hasLoaded) {
                 console.log("Scene was already loaded on DOMContentLoaded. Running setupManualLayout.");
                 if (!sceneLayoutReady) {
                      setupManualLayout();
                 }
             }

        }); // Fin DOMContentLoaded

    </script>
</body>
</html>
