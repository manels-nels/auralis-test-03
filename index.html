<!DOCTYPE html>
<html>
<head>
    <title>AURALIS AR Experience (Manual Image Layout)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="AURALIS AR Experience using A-Frame and AR.js with manually defined image layout and user-initiated audio.">

    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        .arjs-loader {
            height: 100%; width: 100%; position: absolute; top: 0; left: 0;
            background-color: rgba(0, 0, 0, 0.85); /* Légèrement plus opaque peut-être */
            z-index: 10000; /* Z-index pour le loader */
            display: flex; justify-content: center; align-items: center;
        }
        .arjs-loader div { text-align: center; font-size: 1.25em; color: white; }
        #wechat-notice {
            position: absolute; top: 10px; left: 10px; right: 10px; padding: 10px;
            background: rgba(0,0,0,0.7); color: white; z-index: 9999; /* Sous le loader */
            font-size: 14px; text-align: center; border-radius: 5px;
        }
        #start-button {
            position: absolute;
            z-index: 10001; /* Z-index PLUS ÉLEVÉ que le loader */
            top: 50%; left: 50%; transform: translate(-50%, -50%);
            padding: 15px 25px; font-size: 1.2em; font-family: sans-serif;
            color: white; background-color: #28a745; border: none;
            border-radius: 8px; cursor: pointer; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: background-color 0.2s ease;
        }
        #start-button:hover { background-color: #218838; }
    </style>
</head>

<body style='margin : 0px; overflow: hidden;'>

    <div id="wechat-notice" onclick="this.style.display='none';">
        <b>Note WeChat:</b> Pour l'expérience AR, cliquez sur '...' puis 'Ouvrir dans le navigateur'.
    </div>

    <div class="arjs-loader" id="arjs-loader-div">
        <div>Loading AURALIS Experience...</div>
    </div>

    <button id="start-button">Start Experience</button>

    <a-scene
        id="ar-scene"
        embedded
        arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'
        renderer='logarithmicDepthBuffer: true; colorManagement: true;'
        vr-mode-ui='enabled: false'
        background="color: #222"> <!-- Ajout d'un fond pour voir si la scène elle-même plante -->

        <a-assets timeout="60000">
             <img id="logoImg" src="images/logo.jpg" crossOrigin="anonymous">
             <img id="wangMengImg" src="images/wang_meng.jpg" crossOrigin="anonymous">
             <img id="yuMiaoImg" src="images/yu_miao.jpg" crossOrigin="anonymous">
             <img id="djBackImg" src="images/dj_back.jpg" crossOrigin="anonymous">
             <img id="stageWideImg" src="images/stage_wide.jpg" crossOrigin="anonymous">
             <img id="stageDuoBlueImg" src="images/stage_duo_blue.jpg" crossOrigin="anonymous">
             <img id="stageDuoDarkImg" src="images/stage_duo_dark.jpg" crossOrigin="anonymous">

             <!-- !!! VÉRIFIEZ CE CHEMIN !!! -->
             <audio id="logoSound" src="audio/your_sound.mp3" preload="auto" crossOrigin="anonymous"></audio>
             <!-- !!! VÉRIFIEZ CE CHEMIN !!! -->
             <a-asset-item id="jellyfishModel" src="models/meduse.glb" crossOrigin="anonymous"></a-asset-item>
        </a-assets>

        <a-entity id="content-container" position="0 1.5 -4.0" rotation="0 0 0" scale="1 1 1"></a-entity>

        <a-gltf-model id="jellyfish"
                      src="#jellyfishModel"
                      position="-1 2 -2" scale="0.3 0.3 0.3" rotation="0 0 0"
                      animation__pos="property: position; from: -1 2 -2; to: 1 1.2 -1.5; dir: alternate; dur: 12000; easing: easeInOutSine; loop: true;"
                      animation__rot="property: rotation; to: 0 360 0; dur: 20000; easing: linear; loop: true;"
                      animation-mixer="clip: *; loop: repeat">
        </a-gltf-model>

        <a-camera cursor="rayOrigin: mouse; fuse: false;" raycaster="objects: [data-interactive]"></a-camera>

    </a-scene>

    <script>
        // --- Configuration ---
        const PANEL_BASE_WIDTH = 1.8;
        const PANEL_COLOR = '#1a1a3a';
        const PANEL_OPACITY = 0.85;
        const BG_Z_OFFSET = -0.01;
        const IMAGE_Z_OFFSET = 0;

        const imagePositions = { /* ... positions comme avant ... */
             'logoImg':         { x: 0,    y: 0,    z: 0.1 },
             'wangMengImg':     { x: -2.2, y: 2,  z: -0.1 },
             'yuMiaoImg':       { x: 2.2,  y: 0.4,  z: -0.1 },
             'stageWideImg':    { x: 0,    y: 2,  z: -0.3 },
             'djBackImg':       { x: 0,    y: -2, z: -0.2 },
             'stageDuoBlueImg': { x: -2.5, y: -0.8, z: 0.2 },
             'stageDuoDarkImg': { x: 2.5,  y: -0.8, z: 0.2 },
         };

        const contentData = [ /* ... données comme avant ... */
             { type: 'image', srcId: 'logoImg', originalWidth: 2, originalHeight: 2 },
             { type: 'image', srcId: 'wangMengImg', originalWidth: 1, originalHeight: 1.2 },
             { type: 'image', srcId: 'yuMiaoImg', originalWidth: 1.5, originalHeight: 1 },
             { type: 'image', srcId: 'stageWideImg', originalWidth: 2, originalHeight: 1.1 },
             { type: 'image', srcId: 'djBackImg', originalWidth: 1, originalHeight: 1.25 },
             { type: 'image', srcId: 'stageDuoBlueImg', originalWidth: 1.8, originalHeight: 1.1 },
             { type: 'image', srcId: 'stageDuoDarkImg', originalWidth: 1.8, originalHeight: 1.1 }
         ];

        let sceneLoaded = false; // Flag pour savoir si la scène est prête

        // --- Fonction createPanel ---
        function createImagePanel(itemData, position) {
            // ... (code identique à avant, s'assure juste que l'ID 'logo-panel' est ajouté) ...
            const container = document.getElementById('content-container');
            if (!container || !itemData || itemData.type !== 'image' || !itemData.srcId) return null;
            const imgElement = document.getElementById(itemData.srcId);
             if (!imgElement || !itemData.originalWidth || !itemData.originalHeight) { console.warn(`Asset/dimensions missing for ${itemData.srcId}`); return null; }

            const entity = document.createElement('a-entity');
            const aspect = itemData.originalWidth / itemData.originalHeight;
            const panelWidth = PANEL_BASE_WIDTH; const panelHeight = panelWidth / aspect;

            entity.setAttribute('animation__scaleup', `property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200; easing: easeOutQuad;`);
            entity.setAttribute('animation__scaledown', `property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200; easing: easeInQuad;`);
            entity.setAttribute('data-interactive', '');

            const imgBgPlane = document.createElement('a-plane');
            imgBgPlane.setAttribute('width', panelWidth * 1.05); imgBgPlane.setAttribute('height', panelHeight * 1.05);
            imgBgPlane.setAttribute('material', `color: ${PANEL_COLOR}; opacity: ${PANEL_OPACITY}; shader: flat;`);
            imgBgPlane.setAttribute('position', `0 0 ${BG_Z_OFFSET - 0.005}`); entity.appendChild(imgBgPlane);

            const imgPlane = document.createElement('a-plane');
            imgPlane.setAttribute('width', panelWidth); imgPlane.setAttribute('height', panelHeight);
            imgPlane.setAttribute('material', `src: #${itemData.srcId}; shader: flat; transparent: true;`);
            imgPlane.setAttribute('position', `0 0 ${IMAGE_Z_OFFSET}`); entity.appendChild(imgPlane);

            if (itemData.srcId === 'logoImg') {
                entity.setAttribute('id', 'logo-panel'); // Assure-toi que l'ID est là
                entity.setAttribute('sound', {
                    src: '#logoSound', loop: true, volume: 0.8, positional: true,
                    distanceModel: 'inverse', refDistance: 1, rolloffFactor: 1
                });
                console.log(`Sound component added to logoImg panel.`);
            }

            entity.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
            container.appendChild(entity);

            // console.log(`Created image panel for ${itemData.srcId} at`, position); // Optionnel
            return entity;
        }

        // --- Fonction setupManualLayout ---
        function setupManualLayout() {
            console.log("Attempting to setup manual layout...");
            const container = document.getElementById('content-container');
            if (!container) { console.error("Could not find #content-container entity."); return; }
            while (container.firstChild) { container.removeChild(container.firstChild); }

            contentData.forEach(item => {
                if (item.type === 'image' && item.srcId && imagePositions[item.srcId]) {
                    const position = imagePositions[item.srcId];
                    createImagePanel(item, position);
                } else if (item.type === 'image' && item.srcId) {
                    console.warn(`Position not defined for ${item.srcId}. Panel not created.`);
                }
            });
            console.log("Manual image layout generated.");
        }

       // --- Fonction playLogoSound (isolée et plus robuste) ---
       function playLogoSound() {
           console.log("Attempting playLogoSound function...");
           try {
               const logoPanel = document.getElementById('logo-panel');
               // Vérification cruciale : le panneau existe-t-il ?
               if (!logoPanel) {
                   console.error("!!! ERROR: logo-panel element not found in DOM. Was setupManualLayout called correctly?");
                   return; // Sortir si le panneau n'existe pas
               }
               console.log("Found logo-panel:", logoPanel);

               // Vérification cruciale : le composant son est-il attaché et prêt ?
               // Il peut prendre un moment à s'initialiser après la création de l'entité.
               if (logoPanel.components && logoPanel.components.sound) {
                   console.log("Sound component found on logo-panel:", logoPanel.components.sound);
                   // Vérifier si le son est déjà en train de jouer (évite les erreurs si on clique plusieurs fois)
                   if (!logoPanel.components.sound.isPlaying) {
                       console.log("Calling playSound()...");
                       logoPanel.components.sound.playSound();
                       console.log("playSound() called.");
                   } else {
                       console.log("Sound is already playing.");
                   }
               } else {
                   // Si le composant n'est pas prêt, on pourrait attendre un peu et réessayer,
                   // mais pour l'instant, loggons l'erreur.
                   console.error("!!! ERROR: Sound component not found or not ready on logo-panel yet.");
                   // Optionnel : essayer de jouer après un délai
                   // setTimeout(playLogoSound, 500);
               }
           } catch (e) {
               console.error("!!! CRITICAL ERROR in playLogoSound:", e);
           }
       }


       // --- Fonction startExperience (plus robuste) ---
       function startExperience() {
            const startButton = document.getElementById('start-button');
            const loader = document.getElementById('arjs-loader-div');
            const sceneEl = document.querySelector('a-scene');

            console.log("Start button clicked. Scene loaded:", sceneLoaded);

            if (startButton) {
                startButton.style.display = 'none'; // Cache le bouton immédiatement
            }
            if (loader) {
                 // Cache le loader aussi, l'expérience commence
                 loader.style.display = 'none';
                 console.log("Hiding AR.js loader.");
            }

            // Vérification : la scène est-elle chargée ?
            if (!sceneLoaded || !sceneEl) {
                 console.error("!!! ERROR: Scene not loaded or not found when startExperience was called!");
                 return; // Ne rien faire si la scène n'est pas prête
            }

            console.log("Attempting to handle audio context and play sound...");
            try {
                const audioListener = sceneEl.audioListener;
                if (!audioListener) {
                    console.warn("A-Frame audioListener not found yet.");
                     // Essayer de jouer le son directement sans manipuler le contexte
                     playLogoSound();
                    return;
                }

                const audioContext = audioListener.context;
                if (!audioContext) {
                     console.warn("Web Audio API AudioContext not found on listener.");
                     playLogoSound();
                    return;
                }

                console.log("AudioContext state:", audioContext.state);

                // Essayer de reprendre le contexte audio s'il est suspendu (nécessaire sur iOS/Chrome)
                if (audioContext.state === 'suspended') {
                    console.log("AudioContext is suspended, attempting resume...");
                    audioContext.resume().then(() => {
                        console.log("AudioContext resumed successfully.");
                        // Le contexte est prêt, maintenant jouer le son
                        playLogoSound();
                    }).catch(e => {
                        console.error("Error resuming AudioContext:", e);
                        // Essayer de jouer même si resume échoue (au cas où)
                        playLogoSound();
                    });
                } else {
                    // Si le contexte est déjà 'running' ou autre
                    console.log("AudioContext state is not suspended, proceeding to play sound.");
                    playLogoSound();
                }

            } catch (e) {
                console.error("!!! CRITICAL ERROR in startExperience (Audio handling):", e);
                // En dernier recours, essayer de jouer le son même si une erreur s'est produite avant
                playLogoSound();
            }
        }

        // --- Initialisation ---
        window.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Content Loaded.");
            const startButton = document.getElementById('start-button');
            const sceneEl = document.querySelector('a-scene');

            if (startButton && sceneEl) {
                // Attache le listener au bouton
                startButton.addEventListener('click', startExperience);
                console.log("Start button event listener added.");

                // Attend que la scène A-Frame soit complètement chargée
                sceneEl.addEventListener('loaded', () => {
                    console.log("A-Frame scene 'loaded' event fired.");
                    sceneLoaded = true; // Marquer la scène comme prête
                    // Générer le layout APRES que la scène soit chargée
                    setupManualLayout();
                     // Le loader et le bouton sont cachés lors du clic sur 'startExperience'
                     console.log("Scene ready. Waiting for user interaction on Start button.");
                });

                // Gestionnaire d'erreur A-Frame (au cas où)
                sceneEl.addEventListener('error', (event) => {
                   console.error("A-Frame scene error:", event);
                });

                 // Gestionnaire si AR.js échoue (plus difficile à attraper)
                 // On pourrait écouter des événements spécifiques AR.js s'ils existent

            } else {
                console.error("Could not find Start button or A-Frame scene on DOMContentLoaded!");
                // Cache le loader s'il existe, car il n'y a pas de bouton pour démarrer
                const loader = document.getElementById('arjs-loader-div');
                if (loader) loader.style.display = 'none';
            }
        });

    </script>

</body>
</html>
