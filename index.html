<!DOCTYPE html>
<html>
<head>
    <title>AURALIS AR Experience (Asset Count Progress)</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="description" content="AURALIS AR Experience using A-Frame and AR.js with asset count progress indicator.">
    <!-- A-Frame Core -->
    <script src="https://aframe.io/releases/1.3.0/aframe.min.js"></script>
    <!-- AR.js for A-Frame -->
    <script src="https://cdn.jsdelivr.net/gh/AR-js-org/AR.js@3.4.0/aframe/build/aframe-ar.min.js"></script>

    <style>
        body { margin: 0; overflow: hidden; }
        /* --- Style Loader --- */
        .arjs-loader {
            height: 100%; width: 100%; position: absolute; top: 0; left: 0;
            background-color: rgba(0, 0, 0, 0.8); z-index: 9999;
            display: flex; justify-content: center; align-items: center;
            /* Modifier pour aligner verticalement */
            flex-direction: column;
            opacity: 1;
            transition: opacity 0.5s ease-out;
        }
        .arjs-loader-message { /* Style pour le message principal */
             text-align: center; font-size: 1.25em; color: white;
             margin-bottom: 15px; /* Ajouter de l'espace en dessous */
        }
        #progress-counter { /* Style pour le compteur X/9 */
            text-align: center; font-size: 1em; color: #ccc;
        }
        #wechat-notice { position: absolute; top: 10px; left: 10px; right: 10px; padding: 10px; background: rgba(0,0,0,0.7); color: white; z-index: 101; font-size: 14px; text-align: center; border-radius: 5px; }
    </style>
</head>
<body style='margin : 0px; overflow: hidden;'>
    <!-- --- Message pour WeChat --- -->
    <div id="wechat-notice" onclick="this.style.display='none';">
        <b>Note WeChat:</b> Pour l'expérience AR, cliquez sur '...' puis 'Ouvrir dans le navigateur'.
    </div>

    <!-- --- Écran de chargement (modifié) --- -->
    <div class="arjs-loader" id="arjs-loader-div">
        <div class="arjs-loader-message">Chargement AURALIS Experience...</div>
        <!-- Nouvel élément pour le compteur -->
        <div id="progress-counter">0/9</div>
    </div>

    <!-- --- Scène A-Frame AR (Markerless) --- -->
    <a-scene
        id="ar-scene"
        embedded
        arjs='sourceType: webcam; trackingMethod: best; debugUIEnabled: false;'
        renderer='logarithmicDepthBuffer: true; colorManagement: true;'
        vr-mode-ui='enabled: false'>

        <!-- --- Assets --- -->
        <!-- Augmenter le timeout peut être utile comme sécurité -->
        <a-assets timeout="120000">
             <img id="logoImg" src="images/logo.jpg" crossOrigin="anonymous">
             <img id="wangMengImg" src="images/wang_meng.jpg" crossOrigin="anonymous">
             <img id="yuMiaoImg" src="images/yu_miao.jpg" crossOrigin="anonymous">
             <img id="djBackImg" src="images/dj_back.jpg" crossOrigin="anonymous">
             <img id="stageWideImg" src="images/stage_wide.jpg" crossOrigin="anonymous">
             <img id="stageDuoBlueImg" src="images/stage_duo_blue.jpg" crossOrigin="anonymous">
             <img id="stageDuoDarkImg" src="images/stage_duo_dark.jpg" crossOrigin="anonymous">
             <audio id="logoSound" src="audio/your_sound.mp3" preload="auto" crossOrigin="anonymous"></audio>
             <a-asset-item id="jellyfishModel" src="models/meduse.glb" crossOrigin="anonymous"></a-asset-item>
        </a-assets>

        <!-- --- Conteneur pour les panneaux (Ancre globale) --- -->
        <a-entity id="content-container" position="0 1.5 -4.0" rotation="0 0 0" scale="1 1 1">
            <!-- Les panneaux image seront ajoutés ici selon les positions définies en JS -->
        </a-entity>

        <!-- Méduse 3D Animée (l'ID 'jellyfish' est important) -->
        <a-gltf-model id="jellyfish"
                      src="#jellyfishModel"
                      position="-1 2 -2"
                      scale="0.3 0.3 0.3"
                      rotation="0 0 0"
                      animation__pos="..." animation__rot="..." animation-mixer="..."></a-gltf-model>

        <!-- --- Caméra --- -->
        <a-camera cursor="rayOrigin: mouse; fuse: false;" raycaster="objects: [data-interactive]"></a-camera>

    </a-scene>

    <!-- --- Script (modifié pour comptage) --- -->
    <script>
        // --- Configuration (inchangée) ---
        const PANEL_BASE_WIDTH = 1.8; const PANEL_COLOR = '#1a1a3a'; const PANEL_OPACITY = 0.85;
        const BG_Z_OFFSET = -0.01; const IMAGE_Z_OFFSET = 0;
        const imagePositions = { /* ... */ }; const contentData = [ /* ... */ ];

        // --- Fonction createImagePanel (inchangée par rapport à l'original) ---
        function createImagePanel(itemData, position) {
            const container = document.getElementById('content-container');
            if (!container || !itemData || itemData.type !== 'image' || !itemData.srcId) return null;
            const imgElement = document.getElementById(itemData.srcId);
             // Ajout d'une vérification plus robuste des dimensions, mais peut encore échouer si l'image n'est pas prête
             const originalWidth = itemData.originalWidth || imgElement?.naturalWidth;
             const originalHeight = itemData.originalHeight || imgElement?.naturalHeight;

            if (!imgElement || !originalWidth || !originalHeight) {
                console.warn(`Asset/dimensions missing or invalid for ${itemData.srcId}. Panel creation might fail or look incorrect.`);
                // Optionnellement, return null ici pour ne pas créer de panneau défectueux
                // return null;
            }


            const entity = document.createElement('a-entity');
            const aspect = (originalWidth && originalHeight) ? originalWidth / originalHeight : 1; // Eviter division par zéro
            const panelWidth = PANEL_BASE_WIDTH;
            const panelHeight = aspect ? panelWidth / aspect : PANEL_BASE_WIDTH; // Hauteur par défaut si aspect invalide

            entity.setAttribute('animation__scaleup', `property: scale; to: 1.1 1.1 1.1; startEvents: mouseenter; dur: 200; easing: easeOutQuad;`);
            entity.setAttribute('animation__scaledown', `property: scale; to: 1 1 1; startEvents: mouseleave; dur: 200; easing: easeInQuad;`);
            entity.setAttribute('data-interactive', '');

            const imgBgPlane = document.createElement('a-plane');
            imgBgPlane.setAttribute('width', panelWidth * 1.05); imgBgPlane.setAttribute('height', panelHeight * 1.05);
            imgBgPlane.setAttribute('material', `color: ${PANEL_COLOR}; opacity: ${PANEL_OPACITY}; shader: flat;`);
            imgBgPlane.setAttribute('position', `0 0 ${BG_Z_OFFSET - 0.005}`);
            entity.appendChild(imgBgPlane);

            const imgPlane = document.createElement('a-plane');
            imgPlane.setAttribute('width', panelWidth); imgPlane.setAttribute('height', panelHeight);
            imgPlane.setAttribute('material', `src: #${itemData.srcId}; shader: flat; transparent: true;`);
            imgPlane.setAttribute('position', `0 0 ${IMAGE_Z_OFFSET}`);
            entity.appendChild(imgPlane);

            if (itemData.srcId === 'logoImg') {
                entity.setAttribute('sound', { src: '#logoSound', autoplay: true, loop: true, volume: 0.8, positional: true, distanceModel: 'inverse', refDistance: 1, rolloffFactor: 1 });
                console.log(`Attempting to add sound component to logoImg panel.`);
            }

            entity.setAttribute('position', `${position.x} ${position.y} ${position.z}`);
            container.appendChild(entity);

            // console.log(`Created image panel for ${itemData.srcId} at`, position); // Moins de logs
            return entity;
        }

        // --- Fonction setupManualLayout (inchangée par rapport à l'original) ---
        function setupManualLayout() {
            console.log("Setting up manual layout...");
            const container = document.getElementById('content-container');
            if (!container) { console.error("Could not find #content-container entity."); return; }
            while (container.firstChild) { container.removeChild(container.firstChild); } // Vider

            contentData.forEach(item => {
                if (item.type === 'image' && item.srcId && imagePositions[item.srcId]) {
                    createImagePanel(item, imagePositions[item.srcId]);
                } else if (item.type === 'image' && item.srcId) {
                    console.warn(`Position not defined in imagePositions for ${item.srcId}. Panel not created.`);
                }
            });
            console.log("Manual image layout setup finished.");
        }

        // --- NOUVELLE LOGIQUE DE CHARGEMENT PAR COMPTAGE ---
        document.addEventListener('DOMContentLoaded', () => {
            const TOTAL_ASSET_COUNT = 9; // 7 images + 1 audio + 1 modèle
            let loadedAssetCount = 0;
            let loaderHidden = false;
            let sceneLoaded = false; // Pour savoir si setupManualLayout a été appelé

            const progressCounter = document.getElementById('progress-counter');
            const loaderDiv = document.getElementById('arjs-loader-div');
            const sceneEl = document.querySelector('a-scene');
            const assetsEl = document.querySelector('a-assets'); // Pour timeout

            // IDs des assets
            const imageIds = ['logoImg', 'wangMengImg', 'yuMiaoImg', 'djBackImg', 'stageWideImg', 'stageDuoBlueImg', 'stageDuoDarkImg'];
            const audioId = 'logoSound';
            const modelEntityId = 'jellyfish'; // ID de l'entité <a-gltf-model>

             // Utiliser un Set pour éviter de compter le même asset deux fois
             const loadedAssetIds = new Set();

            function checkIfComplete() {
                 if (loaderHidden) return; // Déjà caché

                 if (loadedAssetIds.size >= TOTAL_ASSET_COUNT) {
                     console.log(`All ${TOTAL_ASSET_COUNT} assets reported loaded. Hiding loader.`);
                     loaderHidden = true;
                     // Mettre 9/9 explicitement
                     progressCounter.textContent = `${TOTAL_ASSET_COUNT}/${TOTAL_ASSET_COUNT}`;
                     // Délai final court pour laisser le temps de voir 9/9
                     setTimeout(() => {
                         loaderDiv.style.opacity = '0';
                         setTimeout(() => { loaderDiv.style.display = 'none'; }, 500); // Durée transition
                     }, 300);
                 } else {
                      // Mettre à jour le compteur même si pas complet
                      progressCounter.textContent = `${loadedAssetIds.size}/${TOTAL_ASSET_COUNT}`;
                 }
            }

            function assetLoadedCallback(assetId) {
                if (!loadedAssetIds.has(assetId)) {
                    console.log(`Asset loaded: ${assetId}`);
                    loadedAssetIds.add(assetId);
                    checkIfComplete();
                }
            }

            // --- Écouteurs pour chaque asset ---

            // Images
            imageIds.forEach(id => {
                const img = document.getElementById(id);
                if (img) {
                    if (img.complete) { // Gérer cache
                        assetLoadedCallback(id);
                    } else {
                        img.addEventListener('load', () => assetLoadedCallback(id), { once: true });
                        img.addEventListener('error', () => console.error(`Failed image: ${id}`), { once: true });
                    }
                } else { console.warn(`Image ${id} not found.`); }
            });

            // Audio
            const audio = document.getElementById(audioId);
            if (audio) {
                if (audio.readyState >= 4) { // HAVE_ENOUGH_DATA
                    assetLoadedCallback(audioId);
                } else {
                    audio.addEventListener('canplaythrough', () => assetLoadedCallback(audioId), { once: true });
                    audio.addEventListener('error', () => console.error(`Failed audio: ${audioId}`), { once: true });
                }
            } else { console.warn(`Audio ${audioId} not found.`); }

            // Modèle 3D (sur l'entité GLTF)
            function setupModelListener() {
                const modelEntity = document.getElementById(modelEntityId);
                if (modelEntity) {
                     // Vérifier si l'événement n'a pas déjà été ajouté (par sécurité)
                     if (!modelEntity.hasModelLoadedListener) {
                         console.log(`Attaching 'model-loaded' listener to ${modelEntityId}`);
                         modelEntity.addEventListener('model-loaded', () => assetLoadedCallback(modelEntityId), { once: true });
                         modelEntity.hasModelLoadedListener = true; // Marqueur pour éviter double ajout
                     }
                } else {
                     // L'entité n'existe pas encore, on réessaiera si scene.loaded n'est pas encore passé
                    if (!sceneLoaded) {
                         console.warn(`Model entity ${modelEntityId} not found, will retry on scene load.`);
                    } else {
                         console.error(`Model entity ${modelEntityId} not found even after scene load! Model won't be counted.`);
                    }
                }
            }


            // --- Sécurité : Timeout Global ---
             let timeoutOccurred = false;
             assetsEl.addEventListener('timeout', () => {
                 if (timeoutOccurred || loaderHidden) return;
                 timeoutOccurred = true;
                 console.error(`!!!!! Assets loading timed out via <a-assets> !!!!!`);
                 progressCounter.textContent = `Timeout (${loadedAssetIds.size}/${TOTAL_ASSET_COUNT})`;
                 // progressCounter.classList.add('error'); // Optionnel
             }, { once: true });


            // --- Attendre chargement scène pour Setup Layout ---
            // Note: On ne cache PLUS le loader ici
            sceneEl.addEventListener('loaded', () => {
                 console.log(">>> Scene 'loaded' event fired. Setting up layout.");
                 sceneLoaded = true; // Marquer que la scène est chargée
                 setupManualLayout(); // Créer les entités A-Frame
                 // Essayer d'attacher l'écouteur du modèle maintenant que la scène (et l'entité) devraient exister
                 setupModelListener();
            });

            // Gérer le cas où la scène est déjà chargée + essayer d'attacher listener modèle tôt
            if (sceneEl.hasLoaded) {
                console.log("Scene was already loaded on DOMContentLoaded.");
                sceneLoaded = true;
                setupManualLayout();
                setupModelListener();
            } else {
                 // Essayer d'attacher l'écouteur tôt si possible
                 // Peut échouer si l'entité n'est pas encore là, sera réessayé dans scene.loaded
                 setTimeout(setupModelListener, 100);
            }

        }); // Fin DOMContentLoaded

    </script>

</body>
</html>
